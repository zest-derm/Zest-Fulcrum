generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

enum DiagnosisType {
  PSORIASIS
  ATOPIC_DERMATITIS
  HIDRADENITIS_SUPPURATIVA
  OTHER
}

enum ContraindicationType {
  // Allergy/Hypersensitivity
  DRUG_ALLERGY

  // Cardiovascular
  HEART_FAILURE               // TNF inhibitors (absolute)
  THROMBOSIS                  // JAK inhibitors (absolute)
  VENOUS_THROMBOEMBOLISM      // JAK inhibitors (absolute)
  CARDIOVASCULAR_DISEASE      // JAK inhibitors (relative - increased MACE risk)

  // Neurologic
  MULTIPLE_SCLEROSIS          // TNF inhibitors (absolute)
  DEMYELINATING_DISEASE       // TNF inhibitors (absolute)

  // Gastrointestinal
  INFLAMMATORY_BOWEL_DISEASE  // IL-17 inhibitors (relative - can worsen)
  DIVERTICULITIS              // JAK inhibitors, IL-17 (relative - perforation risk)

  // Infectious Disease
  ACTIVE_INFECTION            // All biologics (absolute)
  ACTIVE_TUBERCULOSIS         // All biologics, especially TNF (absolute)
  LATENT_TUBERCULOSIS         // TNF inhibitors (relative - needs prophylaxis)
  HEPATITIS_B                 // All biologics, especially TNF (relative - can reactivate, needs treatment)
  HEPATITIS_C                 // Biologics (relative - monitor closely)
  HIV                         // Biologics (relative - depends on control)
  OPPORTUNISTIC_INFECTION     // All biologics (absolute)

  // Malignancy
  LYMPHOMA                    // TNF inhibitors (relative - history of lymphoma)
  MALIGNANCY                  // All biologics (relative - active or recent)
  SKIN_CANCER                 // All biologics (relative - non-melanoma)

  // Hepatic/Renal
  HEPATIC_IMPAIRMENT          // Dose adjustments needed
  RENAL_IMPAIRMENT            // Dose adjustments needed

  // Hematologic
  CYTOPENIAS                  // JAK inhibitors, biologics (relative)

  // Immunologic
  IMMUNOCOMPROMISED           // All biologics (relative)
  LIVE_VACCINE_RECENT         // All biologics (relative - wait period)

  // Reproductive
  PREGNANCY                   // Most biologics (relative - risk/benefit)
  BREASTFEEDING               // Most biologics (relative - risk/benefit)

  // Other
  SURGERY_PLANNED             // All biologics (relative - hold peri-operatively)
  OTHER
}

enum ContraindicationSeverity {
  ABSOLUTE    // Never use - unacceptable risk
  RELATIVE    // Use with caution - may be surmountable with monitoring/treatment
}

enum RecommendationType {
  INITIATE_BIOLOGIC        // v2.0: All recommendations are initiations (switching or first-time)
  DOSE_REDUCTION           // Deprecated in v2.0
  SWITCH_TO_BIOSIMILAR     // Deprecated in v2.0
  SWITCH_TO_PREFERRED      // Deprecated in v2.0
  OPTIMIZE_CURRENT         // Deprecated in v2.0
  THERAPEUTIC_SWITCH       // Deprecated in v2.0
  CONTINUE_CURRENT         // Deprecated in v2.0
  CEASE_BIOLOGIC           // Deprecated in v2.0
  ADD_TOPICAL              // Deprecated in v2.0
}

enum DecisionStatus {
  PENDING
  ACCEPTED
  REJECTED
  MODIFIED
}

enum CostDesignation {
  LOW_COST
  HIGH_COST
}

// ============================================
// CORE ENTITIES
// ============================================

model InsurancePlan {
  id               String   @id @default(cuid())
  planName         String
  payerName        String
  effectiveDate    DateTime?
  formularyVersion String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  patients       Patient[]
  formularyDrugs FormularyDrug[]
  uploadLogs     UploadLog[]
  assessments    Assessment[]
}

model Patient {
  id                    String             @id @default(cuid())
  externalId            String?            @unique  // For "Patient ID" format
  pharmacyInsuranceId   String?            @unique  // PRIMARY LINKING FIELD - from test data
  firstName             String
  lastName              String
  dateOfBirth           DateTime

  // Address fields (from test eligibility data)
  streetAddress         String?
  city                  String?
  state                 String?

  // Employment & Contact (from test eligibility data)
  employer              String?
  email                 String?
  phone                 String?

  // Eligibility dates (from test eligibility data)
  eligibilityStartDate  DateTime?
  eligibilityEndDate    DateTime?

  // Cost tracking (from test eligibility data)
  costDesignation       CostDesignation?
  benchmarkCost         Decimal?           @db.Decimal(12, 2)

  // Plan reference (can be null if formulary is just a string)
  planId                String?
  formularyPlanName     String?            // For when plan is just a string like "Aetna December 2024"

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  plan                  InsurancePlan?     @relation(fields: [planId], references: [id])
  currentBiologics      CurrentBiologic[]
  claims                PharmacyClaim[]
  contraindications     Contraindication[]
  assessments           Assessment[]
  recommendations       Recommendation[]

  @@index([pharmacyInsuranceId])
  @@index([externalId])
}

model FormularyDrug {
  id                  String    @id @default(cuid())
  planId              String
  uploadLogId         String?   // Links to dataset upload

  // Core drug identification
  drugName            String
  genericName         String
  drugClass           String    // Changed from enum to String for flexibility

  // Formulation details (NEW - from real-world data)
  formulation         String?   // e.g., "2 Pen Kit", "Prefilled Syringe", "Tablet"
  strength            String?   // e.g., "40MG/0.8ML Subcutaneous", "300MG Dose Subcutaneous"

  // Formulary tier and coverage
  tier                Int       // 1-5, where 5 = Not Covered

  // Prior Authorization and Restrictions (UPDATED)
  requiresPA          String?   // "Yes", "No", "N/A", "Unknown"
  stepTherapyRequired Boolean   @default(false)
  restrictions        String?   // e.g., "PA; DL; QL", "B/D; PA" (raw text from formulary)
  quantityLimit       String?   // e.g., "Max 4 pens per 28 days"

  // Biosimilar relationship
  biosimilarOf        String?

  // FDA approved indications (NEW)
  fdaIndications      String[]  @default([])  // e.g., ["Psoriasis", "PsA", "HS"]

  // NDC Code (NEW - will be populated)
  ndcCode             String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  plan      InsurancePlan @relation(fields: [planId], references: [id])
  uploadLog UploadLog?    @relation(fields: [uploadLogId], references: [id])

  @@index([planId, drugName])
  @@index([drugName])
  @@index([genericName])
  @@index([drugClass])
  @@index([tier])
  @@index([ndcCode])
  @@index([uploadLogId])
}

model CurrentBiologic {
  id           String   @id @default(cuid())
  patientId    String
  drugName     String
  dose         String
  frequency    String
  route        String
  startDate    DateTime
  lastFillDate DateTime?

  // Override tracking (Option C: Store both claims value and override)
  isManualOverride Boolean  @default(false)  // User manually changed from claims data
  claimsDrugName   String?                   // What claims data says
  claimsDose       String?                   // Dose from claims
  claimsFrequency  String?                   // Frequency from claims (inferred)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

model PharmacyClaim {
  id          String   @id @default(cuid())
  patientId   String
  uploadLogId String?  // Links to dataset upload

  // Drug identification - can have drugName OR ndcCode OR both
  drugName    String?
  ndcCode     String?

  // Fill details
  fillDate    DateTime
  daysSupply  Int?
  quantity    Int?

  // Diagnosis (from test claims data)
  diagnosisCode String?  // ICD-10 code like "L40.0", "L20.9"

  // Cost breakdown
  outOfPocket  Decimal? @db.Decimal(10, 2)  // Member Paid / Out of Pocket
  planPaid     Decimal? @db.Decimal(12, 2)  // Plan Paid
  trueDrugCost Decimal? @db.Decimal(12, 2)  // True Drug Cost (net of rebate when available)

  createdAt   DateTime @default(now())

  patient   Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  uploadLog UploadLog? @relation(fields: [uploadLogId], references: [id])

  @@index([patientId, fillDate])
  @@index([drugName])
  @@index([ndcCode])
  @@index([diagnosisCode])
  @@index([uploadLogId])
}

model Contraindication {
  id         String                     @id @default(cuid())
  patientId  String
  type       ContraindicationType
  severity   ContraindicationSeverity   @default(RELATIVE)
  details    String?
  recordedAt DateTime                   @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([type])
  @@index([severity])
}

// ============================================
// PROVIDER MANAGEMENT
// ============================================

model Provider {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assessments      Assessment[]
  providerFeedback ProviderFeedback[]
}

// ============================================
// ASSESSMENT & RECOMMENDATIONS
// ============================================

model Assessment {
  id                     String         @id @default(cuid())
  mrn                    String?        // Medical Record Number (5-9 digits) - optional for legacy data
  patientId              String?        // Optional to support PHI-free assessments
  planId                 String?        // Insurance plan for PHI-free assessments
  providerId             String?        // Provider who created assessment
  medicationType         String?        // "biologic" or "topical" - filters recommendation type
  diagnosis              DiagnosisType
  hasPsoriaticArthritis  Boolean        @default(false)
  dlqiScore              Int            // 0-30
  bmi                    String?        // "<25", "25-30", ">30" - for future logic
  contraindicationOther  String?        @db.Text  // Free text for "Other" contraindication
  currentBiologicName    String?        // Current biologic drug name (for PHI-free assessments)
  currentBiologicDose    String?        // Current biologic dose
  currentBiologicFrequency String?      // Current biologic frequency
  assessmentStartedAt    DateTime?      // When provider started the assessment form
  assessedAt             DateTime       @default(now())

  patient          Patient?           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  plan             InsurancePlan?     @relation(fields: [planId], references: [id])
  provider         Provider?          @relation(fields: [providerId], references: [id])
  recommendations  Recommendation[]
  providerFeedback ProviderFeedback[]

  @@index([patientId])
  @@index([planId])
  @@index([providerId])
  @@index([mrn])
}

model Recommendation {
  id                      String             @id @default(cuid())
  assessmentId            String
  patientId               String?            // Optional to support PHI-free assessments

  // Quadrant classification (deprecated in v2.0 simplified architecture)
  isStable                Boolean?
  isFormularyOptimal      Boolean?
  quadrant                String?

  // Recommendation details
  rank                    Int
  type                    RecommendationType
  drugName                String
  formulation             String?            // e.g., "2 Pen Kit", "Prefilled Syringe"
  strength                String?            // e.g., "40MG/0.8ML Subcutaneous"
  newDose                 String?
  newFrequency            String?

  // Cost analysis
  currentAnnualCost       Decimal?           @db.Decimal(12, 2)
  recommendedAnnualCost   Decimal?           @db.Decimal(12, 2)
  annualSavings           Decimal?           @db.Decimal(12, 2)
  savingsPercent          Decimal?           @db.Decimal(5, 2)
  currentMonthlyOOP       Decimal?           @db.Decimal(10, 2)
  recommendedMonthlyOOP   Decimal?           @db.Decimal(10, 2)

  // Clinical justification
  rationale               String
  evidenceSources         String[]           @default([])
  citations               Json               @default("[]")  // Array of citation objects with inline reference metadata
  monitoringPlan          String?

  // Formulary info
  tier                    Int?
  requiresPA              Boolean?

  // Safety
  contraindicated         Boolean                     @default(false)
  contraindicationReason  String?
  contraindicationSeverity ContraindicationSeverity?  // ABSOLUTE or RELATIVE

  // Decision tracking
  status                  DecisionStatus     @default(PENDING)
  decidedAt               DateTime?
  rejectionReason         String?

  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt

  assessment       Assessment         @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  patient          Patient?           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  providerFeedback ProviderFeedback[]

  @@index([assessmentId])
  @@index([patientId])
  @@index([status])
}

// ============================================
// PROVIDER FEEDBACK & QUALITY TRACKING
// ============================================

model ProviderFeedback {
  id                      String   @id @default(cuid())
  assessmentId            String
  recommendationId        String?  // Which recommendation was accepted (null if declined all)
  mrn                     String   // Copy from assessment for easier querying
  providerId              String?  // Which provider made the decision

  // Which option: 1, 2, 3, or null if declined all
  selectedRank            Int?

  // NEW: Formulary tier selected (from accepted recommendation or manual entry)
  selectedTier            Int?

  // NEW: Assessment time tracking (minutes)
  assessmentTimeMinutes   Decimal? @db.Decimal(5, 2)

  // NEW: Validation questions
  formularyAccurate       Boolean?  // Was formulary accurate?
  literatureAccurate      Boolean?  // Was literature accurate?
  additionalFeedback      String?   @db.Text  // Open-ended feedback
  yearlyRecommendationCost Decimal? @db.Decimal(12, 2)  // Yearly cost of selected recommendation

  // Free text feedback (all optional)
  reasonForChoice         String?  @db.Text  // Why this option was chosen
  reasonAgainstFirst      String?  @db.Text  // Why first wasn't chosen (for rank 2/3)
  reasonForDeclineAll     String?  @db.Text  // Why all declined
  alternativePlan         String?  @db.Text  // What provider plans instead

  createdAt               DateTime @default(now())

  assessment     Assessment      @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  recommendation Recommendation? @relation(fields: [recommendationId], references: [id])
  provider       Provider?       @relation(fields: [providerId], references: [id])

  @@index([mrn])
  @@index([assessmentId])
  @@index([selectedRank])
  @@index([providerId])
}

// ============================================
// KNOWLEDGE BASE (Local RAG with pgvector)
// ============================================

model KnowledgeDocument {
  id              String                        @id @default(cuid())
  title           String
  content         String                        @db.Text
  embedding       Unsupported("vector(1536)")?  // OpenAI text-embedding-3-small
  category        String                        // "CLINICAL_GUIDELINE", "BIOSIMILAR_EVIDENCE", "DOSE_REDUCTION", etc.
  sourceFile      String?
  sourceUrl       String?
  metadata        Json?
  createdAt       DateTime                      @default(now())
  updatedAt       DateTime                      @updatedAt

  @@index([category])
}

// Structured clinical findings (better than raw chunks)
// Each finding is a complete, clean sentence extracted by LLM from a research paper
model ClinicalFinding {
  id              String                        @id @default(cuid())

  // Paper metadata
  paperTitle      String
  paperAuthors    String
  citation        String  // Full citation (e.g., "Atalay et al., J Dermatol Treat, 2021;33(3):1591-1597")
  doi             String?
  pubmedId        String?

  // The actual finding (clean, complete sentence)
  finding         String                        @db.Text

  // Categorization for filtering
  drug            String?  // e.g., "adalimumab", "etanercept"
  drugClass       String?  // e.g., "TNF_INHIBITOR"
  indication      String?  // e.g., "PSORIASIS", "ATOPIC_DERMATITIS"
  findingType     String?  // e.g., "EFFICACY", "SAFETY", "DOSE_REDUCTION", "INTERVAL_EXTENSION"

  // Metadata
  sourceFile      String?
  extractedAt     DateTime                      @default(now())
  extractedBy     String?                       @default("llm")  // Can track if human-reviewed
  reviewed        Boolean                       @default(false)

  // Optional embedding for semantic search (if desired)
  embedding       Unsupported("vector(1536)")?

  createdAt       DateTime                      @default(now())
  updatedAt       DateTime                      @updatedAt

  @@index([drug])
  @@index([indication])
  @@index([findingType])
  @@index([drugClass])
  @@index([reviewed])
}

// ============================================
// DATA UPLOAD TRACKING
// ============================================

model UploadLog {
  id             String   @id @default(cuid())
  uploadType     String   // "FORMULARY", "CLAIMS", "ELIGIBILITY", "KNOWLEDGE"
  fileName       String
  datasetLabel   String?  // User-provided label for the dataset
  planId         String?  // For formulary uploads, links to InsurancePlan
  rowsProcessed  Int
  rowsFailed     Int
  errors         Json?
  uploadedAt     DateTime @default(now())

  plan           InsurancePlan?  @relation(fields: [planId], references: [id])
  formularyDrugs FormularyDrug[]
  claims         PharmacyClaim[]

  @@index([uploadType, uploadedAt])
  @@index([planId])
}

// ============================================
// NDC TO DRUG NAME MAPPING
// ============================================

// New table to handle NDC -> Drug Name conversion
model NdcMapping {
  id          String   @id @default(cuid())
  ndcCode     String   @unique
  drugName    String
  genericName String?
  drugClass   String?  // Changed from enum to String
  strength    String?
  dosageForm  String?
  formulation String?  // Added to match FormularyDrug
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ndcCode])
  @@index([drugName])
  @@index([genericName])
}

// ============================================
// CLINICAL CITATIONS & EVIDENCE
// ============================================

enum CitationType {
  EFFICACY                  // Efficacy data (RCT, observational)
  SAFETY                    // Safety/adverse events data
  BIOSIMILAR_EQUIVALENCE    // Biosimilar similarity studies
  HEAD_TO_HEAD              // Direct comparison studies
  LONG_TERM_OUTCOMES        // Long-term efficacy/safety data
  PHARMACOKINETICS          // PK/PD studies
  REAL_WORLD_EVIDENCE       // Real-world effectiveness
}

enum StudyType {
  RCT                       // Randomized controlled trial
  SYSTEMATIC_REVIEW         // Systematic review
  META_ANALYSIS             // Meta-analysis
  OBSERVATIONAL             // Observational study
  CASE_SERIES               // Case series/reports
  REGISTRY                  // Registry data
}

enum IndicationType {
  PSORIASIS
  PSORIATIC_ARTHRITIS
  ATOPIC_DERMATITIS
  HIDRADENITIS_SUPPURATIVA
  CROHNS_DISEASE
  ULCERATIVE_COLITIS
  RHEUMATOID_ARTHRITIS
  ANKYLOSING_SPONDYLITIS
  OTHER
}

model Citation {
  id                String          @id @default(cuid())

  // Citation metadata
  title             String
  authors           String
  journal           String
  year              Int
  pmid              String?
  doi               String?

  // Study characteristics
  studyType         StudyType
  citationType      CitationType
  sampleSize        Int?
  population        String?         // e.g., "Moderate-to-severe plaque psoriasis"

  // PDF storage (Supabase)
  pdfPath           String          // Path in Supabase storage bucket
  pdfFileName       String          // Original file name

  // Extracted content (pre-processed at upload)
  fullText          String          @db.Text
  keyFindings       String          @db.Text  // Brief summary for quick reference

  // Drug and indication associations
  drugName          String[]        // Drugs covered by this citation (e.g., systematic reviews may cover multiple)
  indications       IndicationType[] @default([])

  // For biosimilar citations - reference to parent drug
  referenceDrugName String?         // If biosimilar study, what's the reference product

  // Metadata
  uploadedAt        DateTime        @default(now())
  uploadedBy        String?         // User who uploaded
  reviewed          Boolean         @default(false)
  reviewedBy        String?
  reviewedAt        DateTime?

  // Editable by users
  notes             String?         @db.Text

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([drugName])
  @@index([citationType])
  @@index([studyType])
  @@index([indications])
  @@index([year])
  @@index([reviewed])
}

// ============================================
// COMPREHENSIVE REVIEW EXTRACTION
// ============================================

enum ReviewExtractionStatus {
  PENDING           // Job created, not started
  ANALYZING_DOCUMENT // Stage 1: Full document analysis
  EXTRACTING_STUDIES // Stage 2: Per-study extraction
  COMPLETED         // Extraction complete, ready for review
  APPROVED          // User approved and citations created
  FAILED            // Extraction failed
  CANCELLED         // User cancelled
}

model ReviewExtractionJob {
  id                String                  @id @default(cuid())

  // Review document info
  pdfPath           String                  // Path in Supabase storage
  pdfFileName       String                  // Original filename
  reviewTitle       String?                 // Extracted review title
  reviewAuthors     String?                 // Review authors
  reviewYear        Int?                    // Review publication year

  // Extraction progress
  status            ReviewExtractionStatus  @default(PENDING)
  totalStudies      Int                     @default(0)     // Total studies identified
  studiesExtracted  Int                     @default(0)     // Studies completed
  studiesApproved   Int                     @default(0)     // Studies approved by user

  // Stage 1 results (document analysis)
  documentStructure Json?                   // Map of document structure
  referenceList     Json?                   // All references extracted

  // Processing metadata
  startedAt         DateTime?
  completedAt       DateTime?
  errorMessage      String?                 @db.Text

  // User who initiated
  uploadedBy        String?

  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  extractedStudies  ExtractedStudy[]

  @@index([status])
  @@index([createdAt])
}

model ExtractedStudy {
  id                    String                @id @default(cuid())
  jobId                 String

  // Citation metadata (extracted)
  title                 String
  authors               String
  journal               String
  year                  Int
  pmid                  String?
  doi                   String?

  // Study characteristics
  studyType             String                // Will map to StudyType enum
  citationType          String                // Will map to CitationType enum
  sampleSize            Int?
  population            String?

  // Drug and indication
  drugName              String[]              // Multiple drugs supported
  indications           String[]              // Will map to IndicationType enum
  referenceDrugName     String?

  // Extracted findings
  keyFindings           String                @db.Text

  // Source location in review
  mentionedOnPages      Int[]                 @default([])  // Which pages mention this study
  extractedFromSections String[]              @default([])  // e.g., ["Results", "Table 2", "Forest Plot"]

  // Quality/confidence
  extractionConfidence  String?               // "high", "medium", "low"
  needsReview           Boolean               @default(false)

  // User review
  approved              Boolean               @default(false)
  edited                Boolean               @default(false)
  notes                 String?               @db.Text

  // Link to created citation (after approval)
  citationId            String?               @unique

  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  job                   ReviewExtractionJob   @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([approved])
  @@index([drugName])
}
