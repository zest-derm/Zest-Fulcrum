generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

enum DrugClass {
  TNF_INHIBITOR
  IL17_INHIBITOR
  IL23_INHIBITOR
  IL4_13_INHIBITOR
  IL12_23_INHIBITOR
  JAK_INHIBITOR
  OTHER
}

enum DiagnosisType {
  PSORIASIS
  ATOPIC_DERMATITIS
  HIDRADENITIS_SUPPURATIVA
  OTHER
}

enum ContraindicationType {
  DRUG_ALLERGY
  HEART_FAILURE
  MULTIPLE_SCLEROSIS
  INFLAMMATORY_BOWEL_DISEASE
  ACTIVE_INFECTION
  PREGNANCY
  HEPATIC_IMPAIRMENT
  RENAL_IMPAIRMENT
  IMMUNOCOMPROMISED
  OTHER
}

enum RecommendationType {
  DOSE_REDUCTION
  SWITCH_TO_BIOSIMILAR
  SWITCH_TO_PREFERRED
  OPTIMIZE_CURRENT
  THERAPEUTIC_SWITCH
}

enum DecisionStatus {
  PENDING
  ACCEPTED
  REJECTED
  MODIFIED
}

// ============================================
// CORE ENTITIES
// ============================================

model InsurancePlan {
  id               String   @id @default(cuid())
  planName         String
  payerName        String
  effectiveDate    DateTime?
  formularyVersion String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  patients       Patient[]
  formularyDrugs FormularyDrug[]
}

model Patient {
  id            String    @id @default(cuid())
  externalId    String?   @unique
  firstName     String
  lastName      String
  dateOfBirth   DateTime
  planId        String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  plan              InsurancePlan      @relation(fields: [planId], references: [id])
  currentBiologics  CurrentBiologic[]
  claims            PharmacyClaim[]
  contraindications Contraindication[]
  assessments       Assessment[]
  recommendations   Recommendation[]
}

model FormularyDrug {
  id                  String    @id @default(cuid())
  planId              String
  drugName            String
  genericName         String
  drugClass           DrugClass
  tier                Int
  requiresPA          Boolean   @default(false)
  stepTherapyRequired Boolean   @default(false)
  annualCostWAC       Decimal?  @db.Decimal(12, 2)
  memberCopayT1       Decimal?  @db.Decimal(10, 2)
  memberCopayT2       Decimal?  @db.Decimal(10, 2)
  memberCopayT3       Decimal?  @db.Decimal(10, 2)
  biosimilarOf        String?
  approvedIndications String[]  @default([])
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  plan InsurancePlan @relation(fields: [planId], references: [id])

  @@index([planId, drugName])
  @@index([drugName])
}

model CurrentBiologic {
  id           String   @id @default(cuid())
  patientId    String
  drugName     String
  dose         String
  frequency    String
  route        String
  startDate    DateTime
  lastFillDate DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

model PharmacyClaim {
  id          String   @id @default(cuid())
  patientId   String
  drugName    String
  ndcCode     String?
  fillDate    DateTime
  daysSupply  Int
  quantity    Int
  outOfPocket Decimal? @db.Decimal(10, 2)
  planPaid    Decimal? @db.Decimal(12, 2)
  createdAt   DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, fillDate])
  @@index([drugName])
}

model Contraindication {
  id         String                @id @default(cuid())
  patientId  String
  type       ContraindicationType
  details    String?
  recordedAt DateTime              @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

// ============================================
// ASSESSMENT & RECOMMENDATIONS
// ============================================

model Assessment {
  id                     String         @id @default(cuid())
  patientId              String
  diagnosis              DiagnosisType
  hasPsoriaticArthritis  Boolean        @default(false)
  dlqiScore              Int            // 0-30
  monthsStable           Int
  additionalNotes        String?
  assessedAt             DateTime       @default(now())

  patient         Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  recommendations Recommendation[]

  @@index([patientId])
}

model Recommendation {
  id                      String             @id @default(cuid())
  assessmentId            String
  patientId               String

  // Quadrant classification
  isStable                Boolean
  isFormularyOptimal      Boolean
  quadrant                String

  // Recommendation details
  rank                    Int
  type                    RecommendationType
  drugName                String
  newDose                 String?
  newFrequency            String?

  // Cost analysis
  currentAnnualCost       Decimal?           @db.Decimal(12, 2)
  recommendedAnnualCost   Decimal?           @db.Decimal(12, 2)
  annualSavings           Decimal?           @db.Decimal(12, 2)
  savingsPercent          Decimal?           @db.Decimal(5, 2)
  currentMonthlyOOP       Decimal?           @db.Decimal(10, 2)
  recommendedMonthlyOOP   Decimal?           @db.Decimal(10, 2)

  // Clinical justification
  rationale               String
  evidenceSources         String[]           @default([])
  monitoringPlan          String?

  // Formulary info
  tier                    Int?
  requiresPA              Boolean?

  // Safety
  contraindicated         Boolean            @default(false)
  contraindicationReason  String?

  // Decision tracking
  status                  DecisionStatus     @default(PENDING)
  decidedAt               DateTime?
  rejectionReason         String?

  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  patient    Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@index([patientId])
  @@index([status])
}

// ============================================
// KNOWLEDGE BASE (Local RAG with pgvector)
// ============================================

model KnowledgeDocument {
  id              String                        @id @default(cuid())
  title           String
  content         String                        @db.Text
  embedding       Unsupported("vector(1536)")?  // OpenAI text-embedding-3-small
  category        String                        // "CLINICAL_GUIDELINE", "BIOSIMILAR_EVIDENCE", "DOSE_REDUCTION", etc.
  sourceFile      String?
  sourceUrl       String?
  metadata        Json?
  createdAt       DateTime                      @default(now())
  updatedAt       DateTime                      @updatedAt

  @@index([category])
}

// ============================================
// DATA UPLOAD TRACKING
// ============================================

model UploadLog {
  id             String   @id @default(cuid())
  uploadType     String   // "FORMULARY", "CLAIMS", "ELIGIBILITY", "KNOWLEDGE"
  fileName       String
  rowsProcessed  Int
  rowsFailed     Int
  errors         Json?
  uploadedAt     DateTime @default(now())

  @@index([uploadType, uploadedAt])
}
