generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

enum DiagnosisType {
  PSORIASIS
  ATOPIC_DERMATITIS
  HIDRADENITIS_SUPPURATIVA
  OTHER
}

enum ContraindicationType {
  DRUG_ALLERGY
  HEART_FAILURE
  MULTIPLE_SCLEROSIS
  INFLAMMATORY_BOWEL_DISEASE
  ACTIVE_INFECTION
  PREGNANCY
  HEPATIC_IMPAIRMENT
  RENAL_IMPAIRMENT
  IMMUNOCOMPROMISED
  OTHER
}

enum RecommendationType {
  DOSE_REDUCTION
  SWITCH_TO_BIOSIMILAR
  SWITCH_TO_PREFERRED
  OPTIMIZE_CURRENT
  THERAPEUTIC_SWITCH
  CONTINUE_CURRENT
}

enum DecisionStatus {
  PENDING
  ACCEPTED
  REJECTED
  MODIFIED
}

enum CostDesignation {
  LOW_COST
  HIGH_COST
}

// ============================================
// CORE ENTITIES
// ============================================

model InsurancePlan {
  id               String   @id @default(cuid())
  planName         String
  payerName        String
  effectiveDate    DateTime?
  formularyVersion String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  patients       Patient[]
  formularyDrugs FormularyDrug[]
  uploadLogs     UploadLog[]
}

model Patient {
  id                    String             @id @default(cuid())
  externalId            String?            @unique  // For "Patient ID" format
  pharmacyInsuranceId   String?            @unique  // PRIMARY LINKING FIELD - from test data
  firstName             String
  lastName              String
  dateOfBirth           DateTime

  // Address fields (from test eligibility data)
  streetAddress         String?
  city                  String?
  state                 String?

  // Employment & Contact (from test eligibility data)
  employer              String?
  email                 String?
  phone                 String?

  // Eligibility dates (from test eligibility data)
  eligibilityStartDate  DateTime?
  eligibilityEndDate    DateTime?

  // Cost tracking (from test eligibility data)
  costDesignation       CostDesignation?
  benchmarkCost         Decimal?           @db.Decimal(12, 2)

  // Plan reference (can be null if formulary is just a string)
  planId                String?
  formularyPlanName     String?            // For when plan is just a string like "Aetna December 2024"

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  plan                  InsurancePlan?     @relation(fields: [planId], references: [id])
  currentBiologics      CurrentBiologic[]
  claims                PharmacyClaim[]
  contraindications     Contraindication[]
  assessments           Assessment[]
  recommendations       Recommendation[]

  @@index([pharmacyInsuranceId])
  @@index([externalId])
}

model FormularyDrug {
  id                  String    @id @default(cuid())
  planId              String
  uploadLogId         String?   // Links to dataset upload

  // Core drug identification
  drugName            String
  genericName         String
  drugClass           String    // Changed from enum to String for flexibility

  // Formulation details (NEW - from real-world data)
  formulation         String?   // e.g., "2 Pen Kit", "Prefilled Syringe", "Tablet"
  strength            String?   // e.g., "40MG/0.8ML Subcutaneous", "300MG Dose Subcutaneous"

  // Formulary tier and coverage
  tier                Int       // 1-5, where 5 = Not Covered

  // Prior Authorization and Restrictions (UPDATED)
  requiresPA          String?   // "Yes", "No", "N/A", "Unknown"
  stepTherapyRequired Boolean   @default(false)
  restrictions        String?   // e.g., "PA; DL; QL", "B/D; PA" (raw text from formulary)
  quantityLimit       String?   // e.g., "Max 4 pens per 28 days"

  // Biosimilar relationship
  biosimilarOf        String?

  // FDA approved indications (NEW)
  fdaIndications      String[]  @default([])  // e.g., ["Psoriasis", "PsA", "HS"]

  // NDC Code (NEW - will be populated)
  ndcCode             String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  plan      InsurancePlan @relation(fields: [planId], references: [id])
  uploadLog UploadLog?    @relation(fields: [uploadLogId], references: [id])

  @@index([planId, drugName])
  @@index([drugName])
  @@index([genericName])
  @@index([drugClass])
  @@index([tier])
  @@index([ndcCode])
  @@index([uploadLogId])
}

model CurrentBiologic {
  id           String   @id @default(cuid())
  patientId    String
  drugName     String
  dose         String
  frequency    String
  route        String
  startDate    DateTime
  lastFillDate DateTime?

  // Override tracking (Option C: Store both claims value and override)
  isManualOverride Boolean  @default(false)  // User manually changed from claims data
  claimsDrugName   String?                   // What claims data says
  claimsDose       String?                   // Dose from claims
  claimsFrequency  String?                   // Frequency from claims (inferred)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

model PharmacyClaim {
  id          String   @id @default(cuid())
  patientId   String
  uploadLogId String?  // Links to dataset upload

  // Drug identification - can have drugName OR ndcCode OR both
  drugName    String?
  ndcCode     String?

  // Fill details
  fillDate    DateTime
  daysSupply  Int?
  quantity    Int?

  // Diagnosis (from test claims data)
  diagnosisCode String?  // ICD-10 code like "L40.0", "L20.9"

  // Cost breakdown
  outOfPocket  Decimal? @db.Decimal(10, 2)  // Member Paid / Out of Pocket
  planPaid     Decimal? @db.Decimal(12, 2)  // Plan Paid
  trueDrugCost Decimal? @db.Decimal(12, 2)  // True Drug Cost (net of rebate when available)

  createdAt   DateTime @default(now())

  patient   Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  uploadLog UploadLog? @relation(fields: [uploadLogId], references: [id])

  @@index([patientId, fillDate])
  @@index([drugName])
  @@index([ndcCode])
  @@index([diagnosisCode])
  @@index([uploadLogId])
}

model Contraindication {
  id         String                @id @default(cuid())
  patientId  String
  type       ContraindicationType
  details    String?
  recordedAt DateTime              @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

// ============================================
// ASSESSMENT & RECOMMENDATIONS
// ============================================

model Assessment {
  id                     String         @id @default(cuid())
  patientId              String
  diagnosis              DiagnosisType
  hasPsoriaticArthritis  Boolean        @default(false)
  dlqiScore              Int            // 0-30
  monthsStable           Int
  additionalNotes        String?
  assessedAt             DateTime       @default(now())

  patient         Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  recommendations Recommendation[]

  @@index([patientId])
}

model Recommendation {
  id                      String             @id @default(cuid())
  assessmentId            String
  patientId               String

  // Quadrant classification
  isStable                Boolean
  isFormularyOptimal      Boolean
  quadrant                String

  // Recommendation details
  rank                    Int
  type                    RecommendationType
  drugName                String
  newDose                 String?
  newFrequency            String?

  // Cost analysis
  currentAnnualCost       Decimal?           @db.Decimal(12, 2)
  recommendedAnnualCost   Decimal?           @db.Decimal(12, 2)
  annualSavings           Decimal?           @db.Decimal(12, 2)
  savingsPercent          Decimal?           @db.Decimal(5, 2)
  currentMonthlyOOP       Decimal?           @db.Decimal(10, 2)
  recommendedMonthlyOOP   Decimal?           @db.Decimal(10, 2)

  // Clinical justification
  rationale               String
  evidenceSources         String[]           @default([])
  monitoringPlan          String?

  // Formulary info
  tier                    Int?
  requiresPA              Boolean?

  // Safety
  contraindicated         Boolean            @default(false)
  contraindicationReason  String?

  // Decision tracking
  status                  DecisionStatus     @default(PENDING)
  decidedAt               DateTime?
  rejectionReason         String?

  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  patient    Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@index([patientId])
  @@index([status])
}

// ============================================
// KNOWLEDGE BASE (Local RAG with pgvector)
// ============================================

model KnowledgeDocument {
  id              String                        @id @default(cuid())
  title           String
  content         String                        @db.Text
  embedding       Unsupported("vector(1536)")?  // OpenAI text-embedding-3-small
  category        String                        // "CLINICAL_GUIDELINE", "BIOSIMILAR_EVIDENCE", "DOSE_REDUCTION", etc.
  sourceFile      String?
  sourceUrl       String?
  metadata        Json?
  createdAt       DateTime                      @default(now())
  updatedAt       DateTime                      @updatedAt

  @@index([category])
}

// Structured clinical findings (better than raw chunks)
// Each finding is a complete, clean sentence extracted by LLM from a research paper
model ClinicalFinding {
  id              String                        @id @default(cuid())

  // Paper metadata
  paperTitle      String
  paperAuthors    String
  citation        String  // Full citation (e.g., "Atalay et al., J Dermatol Treat, 2021;33(3):1591-1597")
  doi             String?
  pubmedId        String?

  // The actual finding (clean, complete sentence)
  finding         String                        @db.Text

  // Categorization for filtering
  drug            String?  // e.g., "adalimumab", "etanercept"
  drugClass       String?  // e.g., "TNF_INHIBITOR"
  indication      String?  // e.g., "PSORIASIS", "ATOPIC_DERMATITIS"
  findingType     String?  // e.g., "EFFICACY", "SAFETY", "DOSE_REDUCTION", "INTERVAL_EXTENSION"

  // Metadata
  sourceFile      String?
  extractedAt     DateTime                      @default(now())
  extractedBy     String?                       @default("llm")  // Can track if human-reviewed
  reviewed        Boolean                       @default(false)

  // Optional embedding for semantic search (if desired)
  embedding       Unsupported("vector(1536)")?

  createdAt       DateTime                      @default(now())
  updatedAt       DateTime                      @updatedAt

  @@index([drug])
  @@index([indication])
  @@index([findingType])
  @@index([drugClass])
  @@index([reviewed])
}

// ============================================
// DATA UPLOAD TRACKING
// ============================================

model UploadLog {
  id             String   @id @default(cuid())
  uploadType     String   // "FORMULARY", "CLAIMS", "ELIGIBILITY", "KNOWLEDGE"
  fileName       String
  datasetLabel   String?  // User-provided label for the dataset
  planId         String?  // For formulary uploads, links to InsurancePlan
  rowsProcessed  Int
  rowsFailed     Int
  errors         Json?
  uploadedAt     DateTime @default(now())

  plan           InsurancePlan?  @relation(fields: [planId], references: [id])
  formularyDrugs FormularyDrug[]
  claims         PharmacyClaim[]

  @@index([uploadType, uploadedAt])
  @@index([planId])
}

// ============================================
// NDC TO DRUG NAME MAPPING
// ============================================

// New table to handle NDC -> Drug Name conversion
model NdcMapping {
  id          String   @id @default(cuid())
  ndcCode     String   @unique
  drugName    String
  genericName String?
  drugClass   String?  // Changed from enum to String
  strength    String?
  dosageForm  String?
  formulation String?  // Added to match FormularyDrug
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ndcCode])
  @@index([drugName])
  @@index([genericName])
}
